{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet" href="/static/css/ticket.css">
{% endblock %}

{% block content %}
<div class="ticket mx-auto my-4">
  <h2>Factura {{ invoice.number }}</h2>
  <table class="w-100">
    <colgroup>
      <col style="width:35%">
      <col style="width:65%">
    </colgroup>
    <tbody>
      <tr><th>Fecha</th><td>{{ invoice.date }}</td></tr>
      <tr><th>Tipo</th><td>{{ 'Venta' if invoice.type == 'sale' else 'Compra' }}</td></tr>
      <tr><th>Cuenta</th><td style="color:{{ account.color if account else '' }}">{{ account.name if account else '' }}</td></tr>
      <tr><th>Concepto</th><td class="description">{{ invoice.description }}</td></tr>
      <tr><th>Monto sin impuesto</th><td class="amount">{{ symbol }} {{ invoice.amount|money }}</td></tr>
      <tr><th>IVA % {{ invoice.iva_percent }}</th><td class="amount">{{ symbol }} {{ invoice.iva_amount|money }}</td></tr>
      {% if invoice.iibb_amount %}
      <tr><th>SIRCREB % {{ invoice.iibb_percent }}</th><td class="amount">{{ symbol }} {{ invoice.iibb_amount|money }}</td></tr>
      {% endif %}
      {% if invoice.type == 'purchase' %}
      <tr><th>Percepciones y otros</th><td class="amount">{{ symbol }} {{ invoice.percepciones|money }}</td></tr>
      {% endif %}
      <tr class="total"><th>Total</th><td class="amount">{{ symbol }} {{ total|money }}</td></tr>
    </tbody>
  </table>
</div>
<div class="text-center mb-4">
  <a href="/billing.html" class="btn btn-secondary">
    <i class="bi bi-arrow-left"></i> Volver a facturación
  </a>
</div>
{% if user and user.is_admin %}
<div class="text-center mb-4">
  <button id="edit-btn" class="btn btn-primary me-2">
    <i class="bi bi-pencil"></i> Editar
  </button>
  <form action="/invoice/{{ invoice.id }}/delete" method="post" class="d-inline" onsubmit="return confirm('¿Eliminar factura?');">
    <button class="btn btn-danger"><i class="bi bi-trash"></i> Eliminar</button>
  </form>
</div>

<div class="modal fade" id="invModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="inv-form">
        <div class="modal-header">
          <h5 class="modal-title">Editar factura</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-sm-6">
              <label class="form-label w-100">Fecha
                <input type="date" name="date" class="form-control" required>
              </label>
            </div>
            <div class="col-sm-6">
              <label class="form-label w-100">Número
                <input type="text" name="number" class="form-control" required>
              </label>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label w-100">Concepto
              <input type="text" name="description" class="form-control" required>
            </label>
          </div>
          <div class="row g-3 justify-content-end mb-3">
            <div class="col-sm-6 ms-auto">
              <label class="form-label w-100">Total sin impuesto
                <input
                  type="text"
                  name="amount"
                  inputmode="decimal"
                  class="form-control text-end"
                  required
                >
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="tax-line">
              <span class="form-label tax-label mb-0 text-end">IVA %</span>
              <div class="tax-field">
                <span class="tax-symbol tax-symbol-percent">%</span>
                <input type="number" step="0.01" name="iva_percent" class="form-control tax-percent text-end" value="21" aria-label="Porcentaje de IVA">
              </div>
              <div class="tax-field tax-field-amount">
                <span class="tax-symbol tax-symbol-currency">$</span>
                <input type="text" name="iva_amount" class="form-control tax-amount text-end" aria-label="Monto de IVA">
              </div>
            </div>
          </div>
          <div id="ret-row" class="mb-3 d-none">
            <div class="tax-line">
              <span class="form-label tax-label mb-0 text-end">Percepciones y otros</span>
              <div class="tax-field tax-field-amount">
                <span class="tax-symbol tax-symbol-currency">$</span>
                <input type="text" name="percepciones" class="form-control tax-amount text-end" aria-label="Monto de Percepciones y otros">
              </div>
            </div>
          </div>
          <div id="iibb-row" class="mb-3 d-none">
            <div class="tax-line">
              <span class="form-label tax-label mb-0 text-end">SIRCREB %</span>
              <div class="tax-field">
                <span class="tax-symbol tax-symbol-percent">%</span>
                <input type="number" step="0.01" name="iibb_percent" class="form-control tax-percent text-end" value="3" aria-label="Porcentaje de SIRCREB">
              </div>
              <div class="tax-field tax-field-amount">
                <span class="tax-symbol tax-symbol-currency">$</span>
                <input type="text" name="iibb_amount" class="form-control tax-amount text-end" aria-label="Monto de SIRCREB">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <span class="form-label d-block">Cuenta de facturación:</span>
            <span id="billing-account" class="fw-bold"></span>
            <input type="hidden" name="account_id">
          </div>
          <div id="inv-alert" class="alert d-none" role="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script id="invoice-data" type="application/json">{{ invoice|tojson }}</script>
<script id="account-data" type="application/json">{{ account|tojson }}</script>
{% endif %}
{% endblock %}

{% block scripts %}
{% if user and user.is_admin %}
<script type="module" src="/static/js/invoice_edit.js?v=2"></script>
{% endif %}
{% endblock %}
